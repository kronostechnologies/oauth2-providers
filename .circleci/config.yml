version: 2
aliases:
  # Variables
  - &composer_install_cache_key v4-composer-install-{{ checksum "composer.lock" }}

jobs:
  checkout_code:
    docker:
      - image: node:9
    steps:
      - checkout
      - persist_to_workspace:
          root: .
          paths:
            - .
  composer_install:
    docker:
      - image: composer:1.6
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - *composer_install_cache_key
      - run: mkdir -p ~/.ssh/ && ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      - run: test -d vendor || composer install -n --prefer-dist
      - run:
          name: "Cleanup .git folders"
          command: 'find . -type d -name .git -exec rm -rf "{}" +'
      - save_cache:
          key: *composer_install_cache_key
          paths: vendor
    phpunit:
      working_directory: ~/
      docker:
      - image: php:5.6-cli-alpine
        command: /sbin/init
      steps:
      - checkout
      - restore_cache:
          name: "Restoring composer install cache"
          key: *composer_install_cache_key
      - run: vendor/bin/phpunit
workflows:
  version: 2
  composer_and_phpunit:
    jobs:
    - checkout_code
    - composer_install:
        requires:
        - checkout_code
    - phpunit:
        requires:
        - composer_install