version: 2
aliases:
  - &composer_install_cache_key v1-composer-install-{{ checksum "composer.lock" }}

workflows:
  version: 2
  composer_and_phpunit:
    jobs:
    - build
    - phpunit:
        requires:
        - build

jobs:
  build:
    parallelism: 1
    working_directory: ~/kronostechnologies/oauth2-providers
    docker:
    - image: composer:1.6
    steps:
    - checkout
    - restore_cache:
        keys:
        - *composer_install_cache_key
    - run: mkdir -p ~/.ssh/ && ssh-keyscan -H github.com >> ~/.ssh/known_hosts
    - run: test ! -d vendor && composer install -n --prefer-dist --no-dev --no-autoloader || true
    - run:
        name: "Cleanup .git folders"
        command: 'find . -type d -name .git -exec rm -rf "{}" +'
    - save_cache:
        key: *composer_install_cache_key
        paths:
          vendor

  phpunit:
    parallelism: 1
    working_directory: ~/kronostechnologies/oauth2-providers
    docker:
    - image: php:5.6-cli-alpine
      command: /sbin/init
    steps:
    - restore_cache:
        name: "Restoring composer install cache"
        key: *composer_install_cache_key
    - run: vendor/bin/phpunit
